# Mako Game Server
> Linux课程大作业的C语言服务端。

# 一、开发环境
* 服务端：操作系统CentOS 7，IDE Clion
* 客户端：操作系统Mac OS，IDE Android Studio

# 二、项目简介
该项目是一个名为《憧子吃茉子》的Android多人小游戏，进入游戏的用户可操纵憧子在地图上移动，吃掉地图上的茉子，增加自己的分数。游戏中会显示所有在游戏中的用户的位置以及分数，以便玩家进行比较。服务端使用C语言进行编写，运行在Linux系统环境中；客户端使用Kotlin语言进行编写，运行在Android系统环境中。

# 三、关键技术：
* Socket。使用socket来创建网络套接字，与客户端进行通信。该项目中使用socket、TCP协议创建与客户端的长连接。
* Epoll。使用linux中的epoll技术实现多路IO复用，这样使用单个进程就能对多个客户端的文件描述符进行监听，而不是为每一个这样的文件描述符分配一个进程，这样极大地减少了资源的占用。
* Aio。使用linux中的aio(异步IO)来实现对客户端消息的读取。使用aio_read不会造成进程阻塞，而是当读取完毕后，使用一个信号来通知进程读取到的数据。这样可以减少进程阻塞占用资源带来的性能影响。
* Actor模型。使用Actor模型来实现数据的并发访问控制(data-process)。Actor模型要求在逻辑层面上实现对数据并发访问冲突的控制（消息队列），而不是使用信号量加锁的方式。这样可以极大减少加锁等待数据修改结果导致的进程阻塞带来的性能影响。

# 四、服务端架构
服务端采用C语言进行编写，运行在Linux系统环境中。总体架构图如下所示：
[![6MTeDs.png](https://s3.ax1x.com/2021/03/07/6MTeDs.png)](https://imgtu.com/i/6MTeDs)
如上图所示，服务端采用全进程的架构，分为三组进程：
* 主进程：其它进程的父进程，会创建其它两组进程，随后开启一个循环，accept监听客户端的连接。收到客户端的连接后，会把代表客户端的文件描述符存储到数组中，并分发给epoll-group进程组中的一个进程(负载均衡)。该进程还注册一个可靠信号，收到该信号时，连接一个消息队列接收发送该信号的进程的消息。然后将该消息发送给所有连接的客户端。
* Epoll-group进程组：该进程组由主进程创建，并将进程号存储到一个数组当中。该进程组中的进程会开启一个循环，在该循环中，使用epoll对自己负责的客户端文件描述符进行可读事件和断开事件的监听。当监听到文件描述符可读时，则读取客户端指令数据(使用linux-aio)，并发送给data-process进程；当监听到客户端断开时，则将该文件描述符清出epoll的监听。该进程注册两个可靠信号：一个用于aio_read读取数据完成后获取数据内容。另一个用于主进程向该进程分发一个客户端文件描述符。
* data进程：该进程用于存储游戏的数据，使用消息队列接收修改数据的消息，避免使用共享内存以及信号量进行加锁。数据修改完毕后，向主进程发送一个信号，通知主进程向所有客户端发送游戏数据。